-- LocalScript: Draggable 45x45 Lock-On Button (Roblox Studio friendly)
-- Dán vào StarterGui trong một ScreenGui

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Tạo ScreenGui nếu cần (nếu bạn đã có ScreenGui, có thể bỏ phần này và dán script vào trong ScreenGui đó)
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "LockOnGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = PlayerGui

-- Tạo nút 45x45
local button = Instance.new("TextButton")
button.Name = "LockButton"
button.Size = UDim2.fromOffset(45, 45)
button.Position = UDim2.new(0, 20, 0.8, 0) -- mặc định, bạn có thể kéo nó đi
button.AnchorPoint = Vector2.new(0,0)
button.Text = "Lock"
button.Font = Enum.Font.SourceSansBold
button.TextSize = 18
button.BackgroundColor3 = Color3.fromRGB(40,40,40)
button.TextColor3 = Color3.fromRGB(255,255,255)
button.BorderSizePixel = 0
button.AutoButtonColor = false
button.Parent = screenGui

-- Tùy chọn nhìn/lock
local FOV = 120 -- độ
local LockedTarget = nil
local Locking = false
local Smoothness = 0.18 -- 0..1 (giá nhỏ hơn = mượt/chậm hơn)
local MaxTargetDistance = 250 -- tối đa khoảng cách xét target (tùy chỉnh)

-- Hàm tìm người gần nhất nằm trong FOV
local function GetClosestPlayer()
	local closest = nil
	local bestDist = math.huge
	local camPos = Camera.CFrame.Position
	local camDir = Camera.CFrame.LookVector

	for _, pl in pairs(Players:GetPlayers()) do
		if pl ~= LocalPlayer then
			local char = pl.Character
			if char and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChildOfClass("Humanoid") and char:FindFirstChildOfClass("Humanoid").Health > 0 then
				local hrp = char.HumanoidRootPart
				local toTarget = hrp.Position - camPos
				local dist = toTarget.Magnitude
				if dist <= MaxTargetDistance then
					-- tránh vector.zero
					local dir = toTarget.Unit
					local dot = camDir:Dot(dir)
					-- clamp vì dot có thể hơi vượt do số thực
					if dot > 1 then dot = 1 elseif dot < -1 then dot = -1 end
					local angle = math.deg(math.acos(dot))
					if angle <= (FOV / 2) then
						if dist < bestDist then
							bestDist = dist
							closest = pl
						end
					end
				end
			end
		end
	end

	return closest
end

-- Cập nhật camera mượt khi đang lock
RunService.RenderStepped:Connect(function(dt)
	if Locking and LockedTarget and LockedTarget.Character and LockedTarget.Character:FindFirstChild("HumanoidRootPart") then
		local hrp = LockedTarget.Character.HumanoidRootPart
		-- nếu target chết hay mất thì tự unlock
		local hum = LockedTarget.Character:FindFirstChildOfClass("Humanoid")
		if not hum or hum.Health <= 0 then
			Locking = false
			LockedTarget = nil
			button.Text = "Lock"
			button.BackgroundColor3 = Color3.fromRGB(40,40,40)
			return
		end

		local current = Camera.CFrame
		local goal = CFrame.new(current.Position, hrp.Position)
		-- Lerp between current and goal for smoothing
		Camera.CFrame = current:Lerp(goal, Smoothness)
	end
end)

-- Khi bấm nút: lock/unlock
button.MouseButton1Click:Connect(function()
	if not Locking then
		local target = GetClosestPlayer()
		if target then
			LockedTarget = target
			Locking = true
			button.Text = "Unlock"
			button.BackgroundColor3 = Color3.fromRGB(75,160,75) -- xanh khi lock
		else
			-- thông báo nhanh nếu không có mục tiêu
			local old = button.Text
			button.Text = "No Target"
			task.delay(0.6, function()
				if not Locking then
					button.Text = old
				end
			end)
		end
	else
		-- unlock
		Locking = false
		LockedTarget = nil
		button.Text = "Lock"
		button.BackgroundColor3 = Color3.fromRGB(40,40,40)
	end
end)

-- ========== Dragging (hỗ trợ chuột và cảm ứng) ==========
-- Implementation: track input delta, di chuyển button theo kích thước màn hình

button.Active = true

local dragging = false
local dragInput = nil
local dragStart = nil
local startPos = nil

local function updatePosition(input)
	local delta = input.Position - dragStart
	local newX = startPos.X.Offset + delta.X
	local newY = startPos.Y.Offset + delta.Y

	-- giữ nút trong màn hình (clamp)
	local screenX = button.Parent.AbsoluteSize.X
	local screenY = button.Parent.AbsoluteSize.Y
	local btnW = button.AbsoluteSize.X
	local btnH = button.AbsoluteSize.Y

	if newX < 0 then newX = 0 end
	if newY < 0 then newY = 0 end
	if newX > screenX - btnW then newX = screenX - btnW end
	if newY > screenY - btnH then newY = screenY - btnH end

	button.Position = UDim2.new(0, newX, 0, newY)
end

button.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = input.Position
		startPos = Vector2.new(button.Position.X, button.Position.Y)
		-- store as UDim2 parts for offsets
		startPos = { X = button.Position, Y = button.Position }
		-- but easier: copy current absolute offset
		startPos = { X = button.Position, Y = button.Position }
		startPos.X = button.Position
		startPos.Y = button.Position
		-- since we need numeric offsets, get AbsolutePosition
		startPos = { X = UDim2.fromOffset(button.AbsolutePosition.X, 0), Y = UDim2.fromOffset(0, button.AbsolutePosition.Y) }
		-- simpler: store numeric offsets
		startPos = { X = button.AbsolutePosition.X, Y = button.AbsolutePosition.Y }

		dragInput = input
		-- Capture movement events
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
			end
		end)
	end
end)

-- Use InputChanged to track movement (MouseMovement or Touch)
LocalPlayer:GetMouse().Move:Connect(function()
	-- noop: to ensure mouse exists on all platforms
end)

game:GetService("UserInputService").InputChanged:Connect(function(input)
	if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
		-- compute delta relative to initial dragStart
		local delta = input.Position - dragStart
		local newX = startPos.X + delta.X
		local newY = startPos.Y + delta.Y

		-- clamp to screen
		local screenX = screenGui.AbsoluteSize.X
		local screenY = screenGui.AbsoluteSize.Y
		local btnW = button.AbsoluteSize.X
		local btnH = button.AbsoluteSize.Y

		if newX < 0 then newX = 0 end
		if newY < 0 then newY = 0 end
		if newX > screenX - btnW then newX = screenX - btnW end
		if newY > screenY - btnH then newY = screenY - btnH end

		button.Position = UDim2.new(0, newX, 0, newY)
	end
end)

-- Ensure dragging ends if input ends
game:GetService("UserInputService").InputEnded:Connect(function(input)
	if input == dragInput then
		dragging = false
		dragInput = nil
	end
end)

-- ========== End of script ==========